<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formulaires de maintenance</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    /* … vos styles inchangés … */
  </style>
</head>
<body>
  <div id="login-overlay">
    <form id="login-box" autocomplete="off" onsubmit="return false;">
      <h2>Connexion</h2>
      <div id="login-error" style="color: #c00; margin-bottom: 8px;"></div>
      <input type="password" id="password" placeholder="Mot de passe" autofocus />
      <br>
      <button type="submit">Entrer</button>
    </form>
  </div>

  <header>
    <!-- … votre header/menu … -->
  </header>

  <div class="filters">
    <label for="siteSelect">Choisir un site :</label>
    <select id="siteSelect">
      <option value="">-- Tous les sites --</option>
    </select>
  </div>

  <div class="table-container">
    <table id="machineTable">
      <thead>
        <tr>
          <th>Machine</th>
          <th>Lien du formulaire</th>
        </tr>
      </thead>
      <tbody>
        <tr id="loading-row"><td colspan="2">Chargement en cours...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const PASSWORDS = { "form2025": ["Armitec CNPE", "Armitec Belliparc"] };
    let userRights = [], fullDataRows = [];
    const siteSelect = document.getElementById('siteSelect');

    // 1. Authentification
    document.getElementById('login-box').onsubmit = () => {
      const pass = document.getElementById('password').value.trim();
      if (PASSWORDS[pass]) {
        userRights = PASSWORDS[pass];
        sessionStorage.setItem('userRights', JSON.stringify(userRights));
        document.getElementById('login-overlay').style.display = 'none';
        init();
      } else {
        document.getElementById('login-error').innerText = 'Mot de passe incorrect.';
        document.getElementById('password').value = '';
      }
    };

    window.onload = () => {
      const stored = sessionStorage.getItem('userRights');
      if (stored) {
        userRights = JSON.parse(stored);
        document.getElementById('login-overlay').style.display = 'none';
        init();
      }
    };

    // 2. Chargement & préparation des données
    function init() {
      loadData()
        .then(rawRows => {
          // On enlève les lignes vides et on trim chaque cellule
          const data = rawRows
            .map(r => r.map(c => typeof c==='string' ? c.trim() : c))
            .filter(r => r.length >= 6 && r.some(cell => cell !== ''));

          // On enlève l'en-tête
          const rows = data.slice(1);

          // On applique les droits (colonne A ⇒ index 0)
          fullDataRows = rows.filter(r => userRights.includes(r[0]));
          console.log('Données filtrées par droits :', fullDataRows);

          setupFilter();
          applySavedFilter();
        })
        .catch(err => {
          console.error(err);
          document.querySelector('#machineTable tbody').innerHTML =
            '<tr><td colspan="2">Erreur de chargement des données.</td></tr>';
        });
    }

    function loadData() {
      const sheetUrl =
        'https://docs.google.com/spreadsheets/d/1DT9QEkPm-bo6oUbBp4d7HKcmU84Uh77IKwh_ccoxeSw/gviz/tq?tqx=out:csv&sheet=Id%20Fichiers%20machines';
      return fetch(sheetUrl)
        .then(res => {
          if (!res.ok) throw new Error('Network error ' + res.status);
          return res.text();
        })
        .then(txt => Papa.parse(txt, { header: false, skipEmptyLines: true }).data);
    }

    // 3. Construction du dropdown à partir des sites autorisés
    function setupFilter() {
      siteSelect.innerHTML = '<option value="">-- Tous les sites --</option>';
      const sites = [...new Set(fullDataRows.map(r => r[0]))].sort();
      console.log('Liste des sites disponibles :', sites);
      sites.forEach(site => {
        const opt = document.createElement('option');
        opt.value = site;
        opt.textContent = site;
        siteSelect.appendChild(opt);
      });

      siteSelect.onchange = () => {
        const sel = siteSelect.value;
        sessionStorage.setItem('selectedSite', sel);
        const filtered = sel
          ? fullDataRows.filter(r => r[0] === sel)
          : fullDataRows;
        renderTable(filtered);
      };
    }

    // 4. Réapplique le filtre enregistré (si page reload)
    function applySavedFilter() {
      const saved = sessionStorage.getItem('selectedSite') || '';
      siteSelect.value = saved;
      siteSelect.onchange();
    }

    // 5. Affichage des lignes dans le tableau
    function renderTable(rows) {
      const tbody = document.querySelector('#machineTable tbody');
      tbody.innerHTML = '';

      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2">Aucune machine pour ce site.</td></tr>';
        return;
      }

      rows.forEach(r => {
        // r[1] = nom machine, r[5] = URL du formulaire
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r[1] || '(pas de nom)'}</td>
          <td>${r[5]
            ? `<a href="${r[5]}" target="_blank">Ouvrir</a>`
            : '(pas de lien)'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 6. Menu & logout (inchangés)
    function toggleMenu() {
      document.getElementById('menu').classList.toggle('open');
    }
    document.addEventListener('click', e => {
      const m = document.getElementById('menu'), b = document.querySelector('.menu-button');
      if (!m.contains(e.target) && e.target !== b) m.classList.remove('open');
    });
    document.querySelectorAll('.menu a').forEach(link => {
      link.addEventListener('click', () => document.getElementById('menu').classList.remove('open'));
    });
    function logout() {
      sessionStorage.clear();
      location.reload();
    }
  </script>
</body>
</html>









