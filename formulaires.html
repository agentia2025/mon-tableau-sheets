<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formulaires de maintenance</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #f5f7fa;
      font-family: Arial, sans-serif;
    }
    h1 {
      color: #4e79a7;
      margin: 2rem 0 1rem 0;
      text-align: center;
      font-size: 2rem;
      letter-spacing: 0.03em;
      font-weight: bold;
    }
    .table-responsive {
      width: 98%;
      max-width: 1200px;
      margin: auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(78,121,167,0.08);
      padding: 0;
      /* Ajout scroll vertical et horizontal */
      overflow-x: auto;
      overflow-y: auto;
      /* Hauteur fixe pour scroll vertical */
      max-height: 60vh;
    }
    .styled-table {
      border-collapse: collapse;
      min-width: 700px;
      width: 100%;
      font-size: 1rem;
      background: #fff;
    }
    .styled-table th, .styled-table td {
      padding: 0.85rem 1rem;
      border-bottom: 1px solid #e0e0e0;
      text-align: left;
      white-space: nowrap;
    }
    .styled-table th {
      background: #4e79a7;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .styled-table tr:hover td {
      background: #f0f6fa;
    }
    @media (max-width: 800px) {
      .styled-table, .styled-table th, .styled-table td {
        font-size: 0.96rem;
      }
      .styled-table th, .styled-table td {
        padding: 0.6rem 0.5rem;
      }
      .table-responsive {
        padding: 0;
        max-height: 50vh;
      }
    }
  </style>
</head>
<body>
  <h1>Formulaires de maintenance</h1>
  <div class="table-responsive">
    <table class="styled-table">
      <thead>
        <tr>
          <th>Machine</th>
          <th>Lien du formulaire</th>
          <th>Gammes</th>
        </tr>
      </thead>
      <tbody id="table-body">
        <tr><td colspan="3">Chargement des données...</td></tr>
      </tbody>
    </table>
  </div>
  <script>
    // Normalisation pour la correspondance des noms de machine
    function normalizeMachineName(str) {
      return (str||"")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-zA-Z0-9]/g, "")
        .toLowerCase()
        .trim();
    }

    let gammesLinks = {};

    // Charge les liens Gammes depuis la colonne I du même Google Sheets (machines en col B, liens en col I)
    function loadGammes(data) {
      gammesLinks = {};
      data.slice(1).forEach(row => {
        const machineName = (row[1]||'').trim(); // colonne B
        const gammeLink = (row[8]||'').trim();   // colonne I
        const machineKey = normalizeMachineName(machineName);
        if(machineKey && gammeLink) gammesLinks[machineKey] = gammeLink;
      });
    }

    function findGammeLink(machineName) {
      const machineKey = normalizeMachineName(machineName);
      if (gammesLinks[machineKey]) return gammesLinks[machineKey];
      for (const key in gammesLinks) {
        if (key.includes(machineKey) && machineKey.length > 0) {
          return gammesLinks[key];
        }
      }
      return null;
    }

    function renderTable(rows) {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';
      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3">Aucune machine trouvée.</td></tr>';
        return;
      }
      rows.forEach(r => {
        const machineName = r[1]||'(pas de nom)';
        const gammeLien = findGammeLink(machineName);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${machineName}</td>
          <td>${r[5]
            ? `<a href="${r[5]}" target="_blank">Ouvrir</a>`
            : '(pas de lien)'}</td>
          <td>${gammeLien
            ? `<a href="${gammeLien}" target="_blank">Gamme PDF</a>`
            : '(pas de gamme)'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Chargement du CSV Google Sheets
    function loadDataAndDisplay() {
      const sheetUrl =
        'https://docs.google.com/spreadsheets/d/1DT9QEkPm-bo6oUbBp4d7HKcmU84Uh77IKwh_ccoxeSw/gviz/tq?tqx=out:csv&sheet=Id%20Fichiers%20machines';
      fetch(sheetUrl)
        .then(res => {
          if (!res.ok) throw new Error('Erreur réseau ' + res.status);
          return res.text();
        })
        .then(txt => {
          const data = Papa.parse(txt, { header: false, skipEmptyLines: true }).data;
          loadGammes(data);
          renderTable(data.slice(1));
        })
        .catch(err => {
          document.getElementById('table-body').innerHTML =
            '<tr><td colspan="3">Erreur de chargement des données.</td></tr>';
        });
    }
    loadDataAndDisplay();
  </script>
</body>
</html>
