<script>
  // … authentification et loadData() inchangés …

  function init() {
    loadData()
      .then(raw => {
        const data = raw.map(r => r.map(c => typeof c==='string' ? c.trim() : c));
        const header = data[0];
        // détecter dynamiquement les colonnes :
        const siteIdx    = header.indexOf('Site');
        const machineIdx = header.indexOf('Machine');
        const linkIdx    = header.indexOf('Lien du formulaire');

        const rows = data.slice(1).filter(r => r.length > linkIdx);
        fullDataRows = rows.filter(r => userRights.includes(r[siteIdx]));

        setupFilter(siteIdx);
        applySavedFilter(siteIdx);
      })
      .catch(err => { /* … */ });
  }

  function setupFilter(siteIdx) {
    siteSelect.innerHTML = '<option value="">-- Tous les sites --</option>';
    // n’utiliser que les sites autorisés
    const sites = [...new Set(fullDataRows.map(r => r[siteIdx]))].sort();
    sites.forEach(site => {
      const opt = document.createElement('option');
      opt.value = opt.textContent = site;
      siteSelect.appendChild(opt);
    });
    siteSelect.onchange = () => {
      const sel = siteSelect.value;
      sessionStorage.setItem('selectedSite', sel);
      const filtered = sel
        ? fullDataRows.filter(r => r[siteIdx] === sel)
        : fullDataRows;
      renderTable(filtered, machineIdx, linkIdx);
    };
  }

  function applySavedFilter(siteIdx) {
    const saved = sessionStorage.getItem('selectedSite') || '';
    siteSelect.value = saved;
    siteSelect.onchange();
  }

  function renderTable(rows, machineIdx, linkIdx) {
    const tbody = document.querySelector('#machineTable tbody');
    tbody.innerHTML = '';
    if (rows.length === 0) {
      tbody.innerHTML = '<tr><td colspan="2">Aucune machine pour ce site.</td></tr>';
      return;
    }
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r[machineIdx]}</td>
        <td><a href="${r[linkIdx]}" target="_blank">Ouvrir</a></td>
      `;
      tbody.appendChild(tr);
    });
  }
</script>







