<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formulaires de maintenance</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    /* … vos styles inchangés … */
  </style>
</head>
<body>
  <div id="login-overlay">
    <form id="login-box" autocomplete="off" onsubmit="return false;">
      <h2>Connexion</h2>
      <div id="login-error" style="color: #c00; margin-bottom: 8px;"></div>
      <input type="password" id="password" placeholder="Mot de passe" autofocus />
      <br>
      <button type="submit">Entrer</button>
    </form>
  </div>

  <header>
    <!-- … votre header/menu … -->
  </header>

  <div class="filters">
    <label for="siteSelect">Choisir un site :</label>
    <select id="siteSelect">
      <option value="">-- Tous les sites --</option>
    </select>
  </div>

  <div class="table-container">
    <table id="machineTable">
      <thead>
        <tr>
          <th>Machine</th>
          <th>Lien du formulaire</th>
        </tr>
      </thead>
      <tbody>
        <tr id="loading-row"><td colspan="2">Chargement en cours...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    // === 1. Gestion des mots de passe et des droits ===
    const PASSWORDS = {
      "form2025": ["Armitec CNPE", "Armitec Belliparc"]
    };
    let userRights = [];
    let fullDataRows = [];
    const siteSelect = document.getElementById('siteSelect');

    // Authentification
    document.getElementById('login-box').onsubmit = () => {
      const pass = document.getElementById('password').value.trim();
      if (PASSWORDS[pass]) {
        userRights = PASSWORDS[pass];
        sessionStorage.setItem('userRights', JSON.stringify(userRights));
        document.getElementById('login-overlay').style.display = 'none';
        init();
      } else {
        document.getElementById('login-error').innerText = 'Mot de passe incorrect.';
        document.getElementById('password').value = '';
        document.getElementById('password').focus();
      }
    };

    // Si déjà authentifié, on saute l'écran
    window.onload = () => {
      const stored = sessionStorage.getItem('userRights');
      if (stored) {
        userRights = JSON.parse(stored);
        document.getElementById('login-overlay').style.display = 'none';
        init();
      }
    };

    // === 2. Chargement & préparation des données ===
    function init() {
      loadData()
        .then(rawRows => {
          // trim + supprimer les lignes vides
          const data = rawRows
            .map(r => r.map(c => typeof c==='string' ? c.trim() : c))
            .filter(r => r.length >= 6 && r.some(cell => cell !== ''));

          // on enlève l'en-tête
          const rows = data.slice(1);

          // on ne garde que les lignes pour lesquelles le site (col A) est dans userRights
          fullDataRows = rows.filter(r => userRights.includes(r[0]));

          setupFilter();
          applySavedFilter();
        })
        .catch(err => {
          console.error(err);
          document.querySelector('#machineTable tbody').innerHTML =
            '<tr><td colspan="2">Erreur de chargement des données.</td></tr>';
        });
    }

    function loadData() {
      const sheetUrl =
        'https://docs.google.com/spreadsheets/d/1DT9QEkPm-bo6oUbBp4d7HKcmU84Uh77IKwh_ccoxeSw/gviz/tq?tqx=out:csv&sheet=Id%20Fichiers%20machines';
      return fetch(sheetUrl)
        .then(res => {
          if (!res.ok) throw new Error('Network error ' + res.status);
          return res.text();
        })
        .then(txt => Papa.parse(txt, { header: false, skipEmptyLines: true }).data);
    }

    // === 3. Construction du dropdown à partir de userRights ===
    function setupFilter() {
      siteSelect.innerHTML = '';

      // Si plusieurs droits : on propose "Tous les sites"
      if (userRights.length > 1) {
        const optAll = document.createElement('option');
        optAll.value = '';
        optAll.textContent = '-- Tous les sites --';
        siteSelect.appendChild(optAll);
      }

      // On n'affiche QUE les sites autorisés
      userRights.forEach(site => {
        const opt = document.createElement('option');
        opt.value = site;
        opt.textContent = site;
        siteSelect.appendChild(opt);
      });

      // Si un seul droit, on pré-sélectionne et on désactive le filtre
      if (userRights.length === 1) {
        siteSelect.value = userRights[0];
        siteSelect.disabled = true;
      } else {
        siteSelect.disabled = false;
      }

      // Au changement : on stocke et on affiche
      siteSelect.onchange = () => {
        sessionStorage.setItem('selectedSite', siteSelect.value);
        const filtered = siteSelect.value
          ? fullDataRows.filter(r => r[0] === siteSelect.value)
          : fullDataRows;
        renderTable(filtered);
      };
    }

    // === 4. Réapplique le filtre enregistré (si reload) ===
    function applySavedFilter() {
      const saved = sessionStorage.getItem('selectedSite') || '';
      // si plusieurs droits, on restaure; sinon on laisse la sélection unique
      if (userRights.length > 1 && saved) {
        siteSelect.value = saved;
      }
      siteSelect.onchange();
    }

    // === 5. Affichage des lignes dans le tableau ===
    function renderTable(rows) {
      const tbody = document.querySelector('#machineTable tbody');
      tbody.innerHTML = '';

      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2">Aucune machine pour ce site.</td></tr>';
        return;
      }

      rows.forEach(r => {
        // r[1] = nom machine, r[5] = URL du formulaire
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r[1] || '(pas de nom)'}</td>
          <td>${r[5]
            ? `<a href="${r[5]}" target="_blank">Ouvrir</a>`
            : '(pas de lien)'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // === 6. Menu & déconnexion (inchangés) ===
    function toggleMenu() {
      document.getElementById('menu').classList.toggle('open');
    }
    document.addEventListener('click', e => {
      const m = document.getElementById('menu'), b = document.querySelector('.menu-button');
      if (!m.contains(e.target) && e.target !== b) m.classList.remove('open');
    });
    document.querySelectorAll('.menu a').forEach(link =>
      link.addEventListener('click', () => document.getElementById('menu').classList.remove('open'))
    );
    function logout() {
      sessionStorage.clear();
      location.reload();
    }
  </script>
</body>
</html>
